#!/bin/zsh

if [ ! -z "$(pgrep offlineimap)" ]
then
	echo "Offlineimap is currently running, exiting"
	exit 1
fi
if [ "$(pgrep fetch_mail | wc -l)" -gt 1 ]
then
	echo "This script is currently running, exiting"
	exit 1
fi

. ~/global
logfile="sync.log"
tmp="fetch${tmpextension}"

[ -d $maildir ] || mkdir -p $maildir
[ -d $maildir/$cpto ] || mkdir -p $maildir/$cpto
:>> $maildir/$logfile
:> $maildir/$tmp

pushd $maildir

print_message "Fetching mail..."
pnonew=true
timeout="600"
failures="0"
while true
do
	{ offlineimap -qo -u Machine.MachineUI } &> $tmp &
	loops="0"
	while [ "$loops" -le "$timeout" ]
	do
		loops="$(($loops + 1))"
		if [ "$(pgrep offlineimap)" = "" ]
		then
			loops="$(($timeout + 66))"
		fi
		sleep 0.1
	done
	if [ "$loops" -lt "$(($timeout + 66))" ]
	then
		print_error "Had to kill offlineimap"
		kill "$(pgrep offlineimap)"
		timeout="$(($timeout + $timeout / 2))"
		failures="$(($failures + 1))"
		print_note "Failed $failures time(s), increased timeout to $timeout"
	else
		timeout="600"
		failures="0"
		echo "---" >> $tmp
		sed -i '/^\/usr\/lib\/python2.6\/site-packages\/offlineimap\// d' $tmp
		sed -i '/self.sslobj = socket.ssl(self.sock,/ d' $tmp
		messages="$(cat $tmp)"
		$(echo $messages >> $logfile)
		if [ "x`echo $messages | grep 'err'`" != "x" ]
		then
			$(echo $messages >> $errorfile)
			print_error "There seems to have been an error."
			print_error "Wating 3 minutes and then trying again."
			sleep 180
			print_note "Continuing"
		else
			if [ "x`ls $inbox/new`" != "x" ]
			then
				print_warn "    New mail!"
				pnonew=true
				cp $inbox/new/* $parsebox
				mv $inbox/new/* $inbox/cur/
			else
				if [ "$pnonew" = true ]
				then
					print_note "No new mail"
					pnonew=false
				fi
			fi
			$(echo "$eightydashes" >> $logfile)
			$(tail -n$savelines $logfile > $tmp)
			$(mv $tmp $logfile)

			sleep 2
		fi
	fi
done
popd

exit 0
